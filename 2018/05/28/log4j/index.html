<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="目标：本文目标在于介绍java项目记录日志的主流方式log4j和tomcat log的配置方式和配合使用方法，  log4j（1.2.x） log4j是Apache公司的一款用于在运行时输出日志的库。log4j的一个鲜明特征是它记录器（Logger）的分层记录，可以控制不同条件下输出日志的粒度，方便调试时获得详细信息和在正式环境减少日志输出量和存储成本。log4j目前支持的输出方式可以是文件，Ou">
<meta property="og:type" content="article">
<meta property="og:title" content="Log4j&amp;&amp;tomcat log调研文档">
<meta property="og:url" content="http://yoursite.com/2018/05/28/log4j/index.html">
<meta property="og:site_name" content="My Hexo Blog">
<meta property="og:description" content="目标：本文目标在于介绍java项目记录日志的主流方式log4j和tomcat log的配置方式和配合使用方法，  log4j（1.2.x） log4j是Apache公司的一款用于在运行时输出日志的库。log4j的一个鲜明特征是它记录器（Logger）的分层记录，可以控制不同条件下输出日志的粒度，方便调试时获得详细信息和在正式环境减少日志输出量和存储成本。log4j目前支持的输出方式可以是文件，Ou">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/图片3.png">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/图片4.png">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/图片5.png">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/图片6.png">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/捕获1.PNG">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/捕获.PNG">
<meta property="og:image" content="http://yoursite.com/2018/05/28/log4j/捕获3.PNG">
<meta property="og:updated_time" content="2018-05-29T04:21:50.200Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Log4j&amp;&amp;tomcat log调研文档">
<meta name="twitter:description" content="目标：本文目标在于介绍java项目记录日志的主流方式log4j和tomcat log的配置方式和配合使用方法，  log4j（1.2.x） log4j是Apache公司的一款用于在运行时输出日志的库。log4j的一个鲜明特征是它记录器（Logger）的分层记录，可以控制不同条件下输出日志的粒度，方便调试时获得详细信息和在正式环境减少日志输出量和存储成本。log4j目前支持的输出方式可以是文件，Ou">
<meta name="twitter:image" content="http://yoursite.com/2018/05/28/log4j/图片3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/05/28/log4j/"/>





  <title>Log4j&&tomcat log调研文档 | My Hexo Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Hexo Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/28/log4j/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M Yi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Hexo Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Log4j&&tomcat log调研文档</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-28T19:52:53+08:00">
                2018-05-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>目标：本文目标在于介绍java项目记录日志的主流方式log4j和tomcat log的配置方式和配合使用方法，</p>
<hr>
<h2 id="log4j（1-2-x）"><a href="#log4j（1-2-x）" class="headerlink" title="log4j（1.2.x）"></a>log4j（1.2.x）</h2><blockquote>
<p>log4j是Apache公司的一款用于在运行时输出日志的库。log4j的一个鲜明特征是它记录器（Logger）的分层记录，可以控制不同条件下输出日志的粒度，方便调试时获得详细信息和在正式环境减少日志输出量和存储成本。log4j目前支持的输出方式可以是文件，OutputStream，java.io.Writer，远程log4j服务器，远程Unix Syslog守护程序或许多其他输出目标。log4j的旧版本1.x是目前使用较多的旧版本。</p>
</blockquote>
<h3 id="log4j实现源码"><a href="#log4j实现源码" class="headerlink" title="log4j实现源码"></a>log4j实现源码</h3><p>查看源码有利于了解配置项结构和自定义log4j的日志输出，所以有必要进行源码分析。<br>为了查看log4j源码，打开我们的项目代码，容易疑惑的是：在我们代码中实际使用的Logger和LoggerFactory是org.slf4j包下的而不是log4j的包。slf4j这是java提供的简单日志接口定义，实际实现需要实现这些接口。用slf4j-log4j12-1.5.10.jar替换slf4j-jdk14-1.5.10.jar即可使用slf4j的接口，log4j的实现。<br>  直接打开项目中引用的log4j.jar就可以看到它的源码，也可以在maven上下载log4j core只看核心类的代码。log4j的日志功能可以抽象出七个核心类/接口：Logger、LoggerRepository、Level、LoggingEvent、Appender、Layout、ObjectRender.类关系如下图：<br>  <img src="/2018/05/28/log4j/./图片3.png" alt="Alt text"><br>Logger用于对日志记录行为的抽象，提供记录不同级别日志的接口；Level对日志级别的抽象；Appender是对记录日志形式（xml、邮件、控制台输出）的抽象；Layout是对日志每行输出的格式的抽象；而LoggingEvent是对一次日志记录过程中所能取到信息的抽象（数据存储类）。LoggerRepository是Logger实例的容器，读取配置文件的信息也是这个类的功能，而ObjectRender是对日志实例的解析接口，处理传入的各类型Message。<br>每次执行一次类似于Logger.error()的语句写日志的时候，流程简略为：业务代码中调用Logger.xx()方法，Logger使用Level将此次调用请求等级与配置文件中等级对比，若本次请求等级更高，就继续日志输出的工作。之后Logger创建存储此次日志信息的LogEvent类，并作为参数传给Appender，Appender使用与自身一一关联的Layout类确定输出文本样式，随后由Appender将日志写入该Appender对应的日志输出中。流程图如下图所示。<br><img src="/2018/05/28/log4j/./图片4.png" alt="Alt text"></p>
<h3 id="log4j使用配置"><a href="#log4j使用配置" class="headerlink" title="log4j使用配置"></a>log4j使用配置</h3><p>Log4j支持两种配置文件格式，一种是XML格式的文件，一种是properties文件。因为IT课现有项目大都使用的properties文件配置方式，所以先从在java项目中使用properties文件配置log4j写起：<br><strong>导入必需jar包：</strong> 导入log4j ,slf4j(可选), slf4j-log4j (可选)三个jar包。<br><strong>.properties的文件位置：</strong>.properties文件应该放在哪并且如何让项目知道它在哪？有三种方式</p>
<blockquote>
<p>方法一：在web.xml中加入节点指定.properties文件位置，默认路径从source folder[ source folder:存放java源代码的文件夹,当然也包括一些package文件夹,还可以包含其他文件. 项目构建后,source folder里面的java自动编译成class文件到相应的/web-inf/classes文件夹中,其他文件也会移到/web-inf/classes相应的目录下.  在eclipse等ide中可以对文件夹右键→buildpath→use as source folder指定。一般可以新建一个source folder用于存放所有的配置文件.]开始<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>log4jConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/log4j.properties<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>方法二：在java代码中使用logger前初始化，默认路径一样从source folder开始，source folder:存放java源代码的文件夹,当然也包括一些package文件夹,还可以包含其他文件. 项目构建后,source folder里面的java自动编译成class文件到相应的/web-inf/classes文件夹中,其他文件也会移到/web-inf/classes相应的目录下.  在eclipse等ide中可以对文件夹右键→buildpath→use as source folder指定。一般可以新建一个source folder用于存放所有的配置文件。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyConfigurator.configure(<span class="string">"log4j.properties"</span>) ;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>方法三(现有项目使用的)：log4j启动时，默认会寻找source folder下的log4j.xml配置文件，若没有，会寻找log4j.properties文件。然后加载配置。所以只要名字是log4j.properties并发在source folder下就可以了。<br>文件位置总结：现在部门中ssh项目大多使用的是第三种配置方式，配置简单方便，但是打包项目时一定会把配置文件也打进war包，如果要更改日志配置就得重启服务器。所以平时项目使用第三种配置，当预计日志需求变化较快时，使用前两种配置方式并把配置文件放到项目外更好。</p>
</blockquote>
<p><strong>编写.properties文件</strong>接下来开始编写properties文件自定义项目的日志输出。配置文件事实上也就是对上文说到的Logger、Appender及Layout进行相应设定。配置文件大致分为三个部分：</p>
<h4 id="配置根Logger："><a href="#配置根Logger：" class="headerlink" title="配置根Logger："></a>配置根Logger：</h4><p>根Logger的配置格式为<br>     log4j.rootLogger = [ level ] , appenderName1, appenderName2, …<br>log4j.additivity.org.apache=false：表示Logger不会在父Logger[2父Logger：可以限定某个类或包中使用另一种日志输出规则，如 log4j.logger.cn.server.child=error,E<br>rootlogger就是child Logger的父Logger]的appender里输出，默认为true。<br>level ：设定日志记录的最低级别，可设的值有OFF、FATAL、ERROR、WARN、INFO、DEBUG、Trace、ALL或者自定义的级别，Log4j建议只使用中间四个（ERROR-DEBUG）级别。通过在这里设定级别，您可以控制应用程序中相应级别的日志信息的开关，比如在这里设定了INFO级别，则应用程序中所有DEBUG级别的日志信息将不会被打印出来。<br>appenderName：就是指定日志信息要使用哪几种方式输出。可以同时指定多个输出目的地，用逗号隔开。<br>例如：log4j.rootLogger＝INFO,A1,B2,C</p>
<h4 id="配置日志信息输出目的地（appender）："><a href="#配置日志信息输出目的地（appender）：" class="headerlink" title="配置日志信息输出目的地（appender）："></a>配置日志信息输出目的地（appender）：</h4><p>appender的配置格式为：<br>log4j.appender.appenderName = className<br>appenderName：自定义appderName，在log4j.rootLogger设置中使用；<br>className：可设值如下：<br>(1)org.apache.log4j.ConsoleAppender（控制台）<br>(2)org.apache.log4j.FileAppender（文件）<br>(3)org.apache.log4j.DailyRollingFileAppender（每天产生一个日志文件）<br>(4)org.apache.log4j.RollingFileAppender（文件大小到达指定尺寸的时候产生一个新的文件）<br>(5)org.apache.log4j.WriterAppender（将日志信息以流格式发送到任意指定的地方）<br>下面介绍各类Appender具体的配置项：</p>
<blockquote>
<p>ConsoleAppender选项：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Threshold=WARN：指定日志信息的最低输出级别，默认为DEBUG。</span><br><span class="line">ImmediateFlush=true：表示所有消息都会被立即输出，设为false则不输出，默认值是true。</span><br><span class="line">Target=System.err：默认值是System.out。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>FileAppender选项：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Append=false：true表示消息增加到指定文件中，false则将消息覆盖指定的文件内容，默认值是true。</span><br><span class="line">File=D:/logs/logging.log4j：指定消息输出到logging.log4j文件中。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>DailyRollingFileAppender选项：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Append=false：true表示消息增加到指定文件中，false则将消息覆盖指定的文件内容，默认值是true。</span><br><span class="line">File=D:/logs/logging.log4j：指定当前消息输出到logging.log4j文件中。</span><br><span class="line">DatePattern='.'yyyy-MM：每月滚动一次日志文件，即每月产生一个新的日志文件。当前月的日志文件名为logging.log4j，前一个月的日志文件名为logging.log4j.yyyy-MM。</span><br><span class="line">另外，也可以指定按周、天、时、分等来滚动日志文件，对应的格式如下：</span><br><span class="line">1)'.'yyyy-MM：每月</span><br><span class="line">2)'.'yyyy-ww：每周</span><br><span class="line">3)'.'yyyy-MM-dd：每天</span><br><span class="line">4)'.'yyyy-MM-dd-a：每天两次</span><br><span class="line">5)'.'yyyy-MM-dd-HH：每小时</span><br><span class="line">6)'.'yyyy-MM-dd-HH-mm：每分钟</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>RollingFileAppender选项：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Append=false：true表示消息增加到指定文件中，false则将消息覆盖指定的文件内容，默认值是true。</span><br><span class="line">File=D:/logs/logging.log4j：指定消息输出到logging.log4j文件中。</span><br><span class="line">MaxFileSize=100KB：后缀可以是KB, MB 或者GB。在日志文件到达该大小时，将会自动滚动，即将原来的内容移到logging.log4j.1文件中。</span><br><span class="line">MaxBackupIndex=2：指定可以产生的滚动文件的最大数，例如，设为2则可以产生logging.log4j.1，logging.log4j.2两个滚动文件和一个logging.log4j文件。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="配置日志信息的输出格式（Layout）："><a href="#配置日志信息的输出格式（Layout）：" class="headerlink" title="配置日志信息的输出格式（Layout）："></a>配置日志信息的输出格式（Layout）：</h4><p>ayout的配置格式为：<br>log4j.appender.appenderName.layout=className<br>className：可设值如下：<br>(1)org.apache.log4j.HTMLLayout（以HTML表格形式布局）<br>(2)org.apache.log4j.PatternLayout（可以灵活地指定布局模式）<br>(3)org.apache.log4j.SimpleLayout（包含日志信息的级别和信息字符串）<br>(4)org.apache.log4j.TTCCLayout（包含日志产生的时间、线程、类别等等信息）<br>(1)HTMLLayout选项：<br>LocationInfo=true：输出java文件名称和行号，默认值是false。<br>Title=My Logging： 默认值是Log4J Log Messages。<br>(2)PatternLayout选项：<br>ConversionPattern=%m%n：设定以怎样的格式显示消息。<br>格式化符号说明：<br>%p：输出日志信息的优先级，即DEBUG，INFO，WARN，ERROR，FATAL。<br>%d：输出日志时间点的日期或时间，默认格式为ISO8601，也可以在其后指定格式，如：%d{yyyy/MM/dd HH:mm:ss,SSS}。<br>%r：输出自应用程序启动到输出该log信息耗费的毫秒数。<br>%t：输出产生该日志事件的线程名。<br>%l：输出日志事件的发生位置，相当于%c.%M(%F:%L)的组合，包括类全名、方法、文件名以及在代码中的行数。例如：test.TestLog4j.main(TestLog4j.java:10)。<br>%c：输出日志信息所属的类目，通常就是所在类的全名。<br>%M：输出产生日志信息的方法名。<br>%F：输出日志消息产生时所在的文件名称。<br>%L:：输出代码中的行号。<br>%m:：输出代码中指定的具体日志信息。<br>%n：输出一个回车换行符，Windows平台为”rn”，Unix平台为”n”。<br>%x：输出和当前线程相关联的NDC(嵌套诊断环境)，尤其用到像java servlets这样的多客户多线程的应用中。<br>%%：输出一个”%”字符。<br>另外，还可以在%与格式字符之间加上修饰符来控制其最小长度、最大长度、和文本的对齐方式。如：<br>1) c：指定输出category的名称，最小的长度是20，如果category的名称长度小于20的话，默认的情况下右对齐。<br>2)%-20c：”-“号表示左对齐。<br>3)%.30c：指定输出category的名称，最大的长度是30，如果category的名称长度大于30的话，就会将左边多出的字符截掉，但小于30的话也不会补空格。</p>
<h4 id="屏蔽框架输出日志干扰"><a href="#屏蔽框架输出日志干扰" class="headerlink" title="屏蔽框架输出日志干扰"></a>屏蔽框架输出日志干扰</h4><p>spring、hibernate、dubbo……这些框架使用commons-logging自动往我们的日志里塞内容导致日志过于庞大。让我们难以找到自己抛出的异常日志。<br>在log4j1.x的处理方法是根据实际使用框架的情况，定义对应的logger将它指定为OFF级别。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log4j.logger.org.springframework=OFF  </span><br><span class="line">log4j.logger.org.apache.struts2=OFF  </span><br><span class="line">log4j.logger.com.opensymphony.xwork2=OFF  </span><br><span class="line">log4j.logger.com.ibatis=OFF  </span><br><span class="line">log4j.logger.org.hibernate=OFF</span><br><span class="line">log4j.logger.com.alibaba.dubbo=OFF</span><br><span class="line">log4j.logger.org.apache.zookeeper=OFF</span><br></pre></td></tr></table></figure></p>
<p>或者用限定包的logger代替rootlogger<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log4j.logger.com.tplink =org.apache.log4j.ConsoleAppender</span><br></pre></td></tr></table></figure></p>
<h4 id="配置文件总览"><a href="#配置文件总览" class="headerlink" title="配置文件总览"></a>配置文件总览</h4><p>下面将展示log4j的整体配置</p>
<h4 id="同项目内多个logger配置"><a href="#同项目内多个logger配置" class="headerlink" title="同项目内多个logger配置"></a>同项目内多个logger配置</h4><p>在配置文件中，新写一个类似于rootlogger定义的语句用来定义子logger<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#指定tplink.Newlogger类专用的logger</span><br><span class="line">log4j.logger.tplink.Newlogger= DEBUG, test</span><br></pre></td></tr></table></figure></p>
<p>然后在业务代码中我们就可以获取这个自定义的logger<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = LoggerFactory.getLogger(Newlogger.class); //参数是class</span><br></pre></td></tr></table></figure></p>
<p>或者不是指定类而是一个名字来定义logger<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log4j.logger.myTest= DEBUG, test2</span><br></pre></td></tr></table></figure></p>
<p>业务代码中使用String来获取logger<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = LoggerFactory.getLogger(“myTest”); //参数是string</span><br></pre></td></tr></table></figure></p>
<h3 id="自定义Appender"><a href="#自定义Appender" class="headerlink" title="自定义Appender"></a>自定义Appender</h3><p>在源码中有一个AppenderSkeleton骨架类，自己写一个类继承它。除了override方法外，自己需要从配置项读取的变量定义后写好getter和setter，就可以自动注入了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.log4j.AppenderSkeleton;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.spi.LoggingEvent;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IMAppender</span> <span class="keyword">extends</span> <span class="title">AppenderSkeleton</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String username; <span class="comment">//从配置文件读取的变量</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub	</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">requiresLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(LoggingEvent event)</span> </span>&#123;</span><br><span class="line">		  System.out.println(<span class="string">"Hello, "</span> + username + <span class="string">" : "</span>+ event.getMessage()); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> username;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.username = username;</span><br><span class="line">	&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="日志性能优化"><a href="#日志性能优化" class="headerlink" title="日志性能优化"></a>日志性能优化</h3><p>影响性能最明显的几个步骤：硬盘读写、网络读写、JDBC，所以优化性能从这几点考虑。<br>设置日志缓存，以及缓存大小<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log4j.appender.A3.BufferedIO=true </span><br><span class="line">#BufferSize单位为字节，默认是8K   </span><br><span class="line">log4j.appender.A3.BufferSize=8192</span><br></pre></td></tr></table></figure></p>
<p>如果日志性能不佳，放弃数据库日志和邮件日志<br>在log4j1中的异步日志性能较差且容易出现死锁，不建议使用</p>
<h3 id="使用xml配置"><a href="#使用xml配置" class="headerlink" title="使用xml配置"></a>使用xml配置</h3><p>因为我们部门在log4j的使用中习惯用.properties文件，而xml在log4j2里被推荐使用，所以在log4j2部分里再作详细介绍。</p>
<h2 id="log4j2"><a href="#log4j2" class="headerlink" title="log4j2"></a>log4j2</h2><p>在log4j的<a href="http://logging.apache.org/log4j/1.2/" target="_blank" rel="noopener">官网</a>上已经给出声明，自 2015-8-5起log4j已经是”reach end of life”，推荐将log4j更新到log4j2。log4j2的使用方式相比较1并没有太大改变，除了配置方式推荐为xml外，在与slf4j的协同上没有改变，也不需要改变旧java代码。（如果需要使用log4j2在java代码中的新特性就得替换slf4j的org.slf4j.LoggerFactory为org.apache.logging.log4j.LogManager）</p>
<h3 id="2-1-log4j2优点"><a href="#2-1-log4j2优点" class="headerlink" title="2.1.log4j2优点"></a>2.1.log4j2优点</h3><blockquote>
<p>log4j2相比1有更好的异步日志性能，下图是官网上的日志吞吐量比较。同时log4j2也解决了1中高并发时出现的大量死锁问题。<br><img src="/2018/05/28/log4j/./图片5.png" alt="Alt text"><br>log4j2支持变量参数的占位符功能<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.debug("Hi, &#123;&#125; &#123;&#125;", u.getA(), u.getB());</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>log4j2的执行记录跟踪和日志标签<br>这两个功能类似，都相当于给日志加上分隔符和类似android logcat的日志标签，用于区分不同模块的日志，省去了在日志字符串中作区分的麻烦。如果要使用的话可以参考官网链接Flow Tracing，Markers。</p>
</blockquote>
<h3 id="log4j2的使用配置"><a href="#log4j2的使用配置" class="headerlink" title="log4j2的使用配置"></a>log4j2的使用配置</h3><h4 id="导入包"><a href="#导入包" class="headerlink" title="导入包"></a>导入包</h4><p>在项目中导入log4j-core-2.x.jar log4j-api-2.x.jar两个包。</p>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>log4j2支持的配置方式有 XML, JSON, YAML,properties（版本2.4后支持properties方式，但是和1中的配置方式也不再相同）。<br>和1一样log4j2也会在classpath自动寻找配置文件，优先级从高到低分别为log4j2-test.properties，log4j2-test.yaml，log4j2-test.json，log4j2-test.xml，log4j2.properties，log4j2.yaml，log4j2.json，log4j2.xml。在没有找到配置文件时，会使用默认配置，输出到控制台。</p>
<blockquote>
<p>xml配置<br>改为xml配置后，log4j要配置的依然是appender、layout、logger三部分。内容与1中的properties文件没有太大差别。下面举个例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="comment">&lt;!--先定义默认的日志级别--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"error"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--先定义所有的appender--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appenders</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--这个输出控制台的配置 节点名字是随便起的 name属性下面配置logger要用到--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"trace"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">!—和1一样的layout，具体配置也没变--</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件会打印出所有信息，这个log每次运行程序会自动清空，由append属性决定，这个也挺有用的，适合临时测试用--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span> <span class="attr">name</span>=<span class="string">"log"</span> <span class="attr">fileName</span>=<span class="string">"log/test.log"</span> <span class="attr">append</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--这个会打印出所有的信息，每次大小超过size，则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"RollingFile"</span> <span class="attr">fileName</span>=<span class="string">"logs/app.log"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">"log/$$&#123;date:yyyy-MM&#125;/app-%d&#123;MM-dd-yyyy&#125;-%i.log.gz"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;yyyy-MM-dd 'at' HH:mm:ss z&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"50MB"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appenders</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--然后定义logger--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loggers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--建立一个默认的root的logger--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"trace"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"RollingFile"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">!—为某个类定义一个logger，name是该类的包路径，如果没有这个类就会视为普通的string命名的logger，log4j2会根据包名决定继承关系”com.tplink”logger就会是下面logger的父logger，additivity决定日志是否需要按照父logger再打印一次--</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">name</span>=<span class="string">"com.tplink.mi.TestClass"</span> <span class="attr">level</span>=<span class="string">"trace"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"RollingFile"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>在例子中可以看到log4j的级别、appender种类和配置项、logger的继承关系、logger和类的绑定都没变。只是appender和logger的配置被不同节点分开，原来用键值对配置的属性改为标签内的属性配置。<br>在java代码中，如果不使用slf4j的话，使用如下语句创建Logger对象和打印日志<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = LogManager.getLogger(Test.class.getName());</span><br><span class="line">logger.error(<span class="string">"error"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="log4j迁移到log4j2"><a href="#log4j迁移到log4j2" class="headerlink" title="log4j迁移到log4j2"></a>log4j迁移到log4j2</h4><p>更改引用的包<br>更改pom.xml配置，删除log4j的引用和低版本slf4j的引用，换成log4j2.x的引用例如<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>换成<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- log4j-slf4j-impl(用于log4j2与slf4j集成) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>如果不用slf4j那只要引入log4jcore和api两个包就行了<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>更改配置文件<br>因为log4j的log4j.properties配置方式在2中不再被支持，所以更新log4j.properties<br>的配置方式或者删除后换成log4j.xml。新的log4j.properties格式和xml配置类似，也是先定义appender再定义logger。例如官网上的例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">status = error</span><br><span class="line">dest = err</span><br><span class="line">name = PropertiesConfig</span><br><span class="line"> </span><br><span class="line">property.filename = target/rolling/rollingtest.log</span><br><span class="line"> </span><br><span class="line">filter.threshold.type = ThresholdFilter</span><br><span class="line">filter.threshold.level = debug</span><br><span class="line"> </span><br><span class="line">appender.console.type = Console</span><br><span class="line">appender.console.name = STDOUT</span><br><span class="line">appender.console.layout.type = PatternLayout</span><br><span class="line">appender.console.layout.pattern = %m%n</span><br><span class="line"> </span><br><span class="line">appender.rolling.type = RollingFile</span><br><span class="line">appender.rolling.name = RollingFile</span><br><span class="line">appender.rolling.fileName = $&#123;filename&#125;</span><br><span class="line">appender.rolling.filePattern = target/rolling2/test1-%d&#123;MM-dd-yy-HH-mm-ss&#125;-%i.log.gz</span><br><span class="line">appender.rolling.layout.type = PatternLayout</span><br><span class="line">appender.rolling.layout.pattern = %d %p %C&#123;1.&#125; [%t] %m%n</span><br><span class="line">appender.rolling.policies.type = Policies</span><br><span class="line">appender.rolling.policies.time.type = TimeBasedTriggeringPolicy</span><br><span class="line">appender.rolling.policies.time.interval = 2</span><br><span class="line">appender.rolling.policies.time.modulate = true</span><br><span class="line">appender.rolling.policies.size.type = SizeBasedTriggeringPolicy</span><br><span class="line">appender.rolling.policies.size.size=100MB</span><br><span class="line">appender.rolling.strategy.type = DefaultRolloverStrategy</span><br><span class="line">appender.rolling.strategy.max = 5</span><br><span class="line"> </span><br><span class="line">appender.list.type = List</span><br><span class="line">appender.list.name = List</span><br><span class="line">appender.list.filter.threshold.type = ThresholdFilter</span><br><span class="line">appender.list.filter.threshold.level = error</span><br><span class="line"> </span><br><span class="line">logger.rolling.name = com.example.my.app</span><br><span class="line">logger.rolling.level = debug</span><br><span class="line">logger.rolling.additivity = false</span><br><span class="line">logger.rolling.appenderRef.rolling.ref = RollingFile</span><br><span class="line"> </span><br><span class="line">rootLogger.level = info</span><br><span class="line">rootLogger.appenderRef.stdout.ref = STDOUT</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>更新java代码中的Logger（可选）<br>之前使用的slf4.org.Logger可以替换成org.apache.logging.log4j.Logger用于使用变量参数的占位符功能。如果应用了slf4j的包，也可以不改任何代码，继续使用slf4.org.Logger。</p>
</blockquote>
<h4 id="屏蔽框架输出日志干扰-1"><a href="#屏蔽框架输出日志干扰-1" class="headerlink" title="屏蔽框架输出日志干扰"></a>屏蔽框架输出日志干扰</h4><p>spring、hibernate、dubbo……这些框架使用commons-logging自动往我们的日志里塞内容导致日志过于庞大。让我们难以找到自己抛出的异常日志。<br>在log4j2的处理方法是根据实际使用框架的情况，定义对应的logger将它指定为OFF级别。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name=&quot;org.springframework&quot; level=&quot;off&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">&lt;/logger&gt;</span><br></pre></td></tr></table></figure></p>
<p>或者在要使用的日志中指定name为自己的包名如”com.tplink”，就只输出这个包的日志。<br>也可以提升整体日志级别到error，因为一般这些框架输出的级别都在debug和info。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name=&quot;com.tplink.ebs&quot; level=&quot;off&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">&lt;appender-ref ref=&quot;Console&quot;/&gt;</span><br><span class="line">&lt;/logger&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="Tomcat日志"><a href="#Tomcat日志" class="headerlink" title="Tomcat日志"></a>Tomcat日志</h2><blockquote>
<p>本部分基于apache tomcat版本7.0-8.5。</p>
</blockquote>
<h3 id="Tomcat日志种类介绍"><a href="#Tomcat日志种类介绍" class="headerlink" title="Tomcat日志种类介绍"></a>Tomcat日志种类介绍</h3><p>tomcat下的日志种类繁多，观察tomcat的日志目录（一般为..\logs）<br><img src="/2018/05/28/log4j/./图片6.png" alt="Alt text"><br>可以看到tomcat的日志分为：<br>|日志种类\作用  |   文件名<br>| :——– | ——–:<br>| Cataline引擎的日志文件、控制台输出的日志      |    catalina.日期.log<br>| Tomcat下内部代码丢出的日志| localhost.日期.log<br>| Tomcat下默认manager应用日志|   manager.日期.log<br>|Access日志|文件名在Servlet.xml配置（一般叫localhost_access_log..日期.log）<br>|log4j配置存储到该目录下的日志|随配置改变<br>catalina.log我们在维护时常看的日志之一，因为在我们的旧项目中，如果log4j指定的输出方式为stdout，那么在unix类系统中会被重定向到catalina.log中。除此之外，它还包含catalina引擎——tomcat的servlet容器本身的报错日志。<br>localhost.log中的内容是jsp页面内部错误的异常。<br>manager.log 是tomcat自带的manager应用的日志，正式项目中一般不开启manager应用。<br>localhost_access_log.log 是记录访问者、访问日期、访问目标的日志。</p>
<h3 id="Tomcat日志配置"><a href="#Tomcat日志配置" class="headerlink" title="Tomcat日志配置"></a>Tomcat日志配置</h3><h4 id="默认JULI实现下的配置"><a href="#默认JULI实现下的配置" class="headerlink" title="默认JULI实现下的配置"></a>默认JULI实现下的配置</h4><p>JULI,指tomcat对java.util.logging API的实现，用于负责日志输出。tomcat也可以通过配置让log4j来负责它的日志。<br>根据官方文档，Tomcat支持各应用各自独立使用日志框架。而Tomcat本身的通用日志系统，即用来输出上文所介绍的catalina.log， localhost.log，manager.log 的日志系统，是默认通过”JULI”实现的。<br>默认Tomcat使用JULI的情况下，并且除了常规的全局java.util.logging配置之外，还支持不同的应用使用不同的配置。全局的配置通常在$ {catalina.base} /conf/logging.properties文件中完成。该文件由java.util.logging.config.file系统属性指定，该属性由启动脚本设置。如果它不可读或未配置，则默认使用JRE中的$ {java.home} /lib/logging.properties文件。<br>在各Web应用程序中。该文件将是WEB-INF / classes / logging.properties。<br>logging.properties配置和java.util.logging的配置方式相似，一样有区分输出级别，从高到低分别是OFF，SEVERE，WARNING，INFO，CONFIG，FINE，FINER，FINEST或ALL设置。处理程序的日志级别阈值默认为INFO，同样，不同包也可以指定不同的日志级别。</p>
<h5 id="logging-properties的三段结构"><a href="#logging-properties的三段结构" class="headerlink" title="logging.properties的三段结构"></a>logging.properties的三段结构</h5><p>logging.properties配置文件由3大部分组成：起始handler申明，配置handler属性，logger适配handler。配置中的handler类似于log4j中的appender，用于指定日志的输出目标；formatter类似于layout，用于指定日志的格式；logger则是记录日志的执行类。<br>下面是示例logging.properties配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#定义handlers，handlers名称格式为 前缀.决定输出目的的handler类</span><br><span class="line">handlers=1catalina.org.apache.juli.FileHandler,2localhost.org.apache.juli.FileHandler, 3manager.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler  </span><br><span class="line">.handlers = 1catalina.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler  </span><br><span class="line">############################################################  </span><br><span class="line">#配置handler属性  </span><br><span class="line">############################################################  </span><br><span class="line"># Cataline引擎的日志文件，文件名catalina.日期.log  </span><br><span class="line">1catalina.org.apache.juli.FileHandler.level = FINE  </span><br><span class="line">1catalina.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs  </span><br><span class="line">1catalina.org.apache.juli.FileHandler.prefix = catalina.  </span><br><span class="line"># Tomcat下内部代码丢出的日志，文件名localhost.日期.log  </span><br><span class="line">2localhost.org.apache.juli.FileHandler.level = FINE  </span><br><span class="line">2localhost.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs  </span><br><span class="line">2localhost.org.apache.juli.FileHandler.prefix = localhost.  </span><br><span class="line"># Tomcat下默认manager应用日志，文件名manager.日期.log  </span><br><span class="line">3manager.org.apache.juli.FileHandler.level = FINE  </span><br><span class="line">3manager.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs  </span><br><span class="line">3manager.org.apache.juli.FileHandler.prefix = manager.  </span><br><span class="line"># 控制台输出的日志，Linux下默认重定向到catalina.out  </span><br><span class="line">java.util.logging.ConsoleHandler.level = FINE  </span><br><span class="line">java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">############################################################  </span><br><span class="line"># logger适配handler  </span><br><span class="line">############################################################  </span><br><span class="line">  </span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO  </span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.org.apache.juli.FileHandler  </span><br><span class="line"># manager的日志  </span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level = INFO  </span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].handlers=3manager.org.apache.juli.FileHandler  </span><br><span class="line"># host-manager的日志  </span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].level = INFO  </span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].handlers=4host-manager.org.apache.juli.FileHandler</span><br></pre></td></tr></table></figure></p>
<p>handler申明中给handler命名格式为“前缀. handler类名”：前缀是数字开头小数点结尾的字符串，用于区分同类的不同handler。handler类决定日志输出形式，这个类有如下表格中的几种实现，不同handler的配置项如最右一栏所示：<br><img src="/2018/05/28/log4j/./捕获1.PNG" alt="Alt text"><br><img src="/2018/05/28/log4j/./捕获.PNG" alt="Alt text"><br><img src="/2018/05/28/log4j/./捕获3.PNG" alt="Alt text"><br>定义并配置handler之后，需要将handeler绑定给logger，logger的命名方式是org.apache.catalina.core.ContainerBase.[${engine}].[${host}].[${context}] ，其中Engine一般是Catalina——tomcat的servlet引擎，context即是tomcat日志的那些种类：“localhost、host-manager”……</p>
<h5 id="Access-Logging的特殊性"><a href="#Access-Logging的特殊性" class="headerlink" title="Access Logging的特殊性"></a>Access Logging的特殊性</h5><p>在上述日志中，有一个特例Access访问日志：因为它需要以较低的开销快速频繁地记录来访情况，所以它并没有使用JULI来实现它在Servlet.xml中的Context或者 Host或者Engine中配置。在上述的配置节中增加类似的value：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">             prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">             pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>Access Logging同样有一系列配置项，以下翻译自官网：<br>|参数 |   描述<br>| :——– | ——–:<br>| className    |    实现类的类名，如果要用默认方式实现日志那就一定设为 org.apache.catalina.valves.AccessLogValve<br>| directory| 文件存放路径，如果是相对路径那么会从$CATALINA_BASE算起。默认值是 “logs”<br>| prefix|   文件名前缀，默认”access_log.”.<br>|suffix|文件名后缀，默认为空字符串<br>|fileDateFormat|自定义在文件名中的时间戳默认值yyyy-MM-dd. 如果你希望每小时刷新一个文件那么改成 yyyy-MM-dd.HH.日期一定会使用 en_US配置本地化。<br>|rotatable|是否需要划分日志文件，默认: true<br>|renameOnRotate|是否禁用分割文件中的timestamp，默认: false<br>|pattern|日志输出的文本的格式<br>|encoding|编码<br>|locale|用于在访问日志行中格式化时间戳的语言环境。 使用显式SimpleDateFormat模式（％{xxx} t）配置的任何时间戳都将在此语言环境中进行格式化。 默认情况下使用Java进程的缺省语言环境。<br>|requestAttributesEnabled|是否显示远程请求传来的参数，默认为false<br>|conditionIf|启用条件日志记录。 如果设置，只有当ServletRequest.getAttribute（）不为null时，才会记录请求。 例如，如果此值设置为important，那么只有ServletRequest.getAttribute（“important”）！= null时才会记录特定的请求。 使用过滤器是一种在许多不同请求上在ServletRequest中设置/取消设置属性的简单方法。<br>|conditionUnless|和上条类似，不过变为ServletRequest.getAttribute（“important”）== null时才会记录特定的请求。<br>|condition|和conditionUnless一样，这个属性用于向后兼容<br>|buffered|决定是否启用缓存，默认: true<br>其中pattern属性时决定日志输出格式的重要属性，它的语法很复杂，但是可以用短配置简化：shorthand pattern pattern=”common” 代表 ‘%h %l %u %t “%r” %s %b’。更详细的语法如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">%a - Remote IP address</span><br><span class="line">%A - Local IP address</span><br><span class="line">%b - Bytes sent, excluding HTTP headers, or '-' if zero</span><br><span class="line">%B - Bytes sent, excluding HTTP headers</span><br><span class="line">%h - Remote host name (or IP address if enableLookups for the connector is false)</span><br><span class="line">%H - Request protocol</span><br><span class="line">%l - Remote logical username from identd (always returns '-')</span><br><span class="line">%m - Request method (GET, POST, etc.)</span><br><span class="line">%p - Local port on which this request was received. See also %&#123;xxx&#125;p below.</span><br><span class="line">%q - Query string (prepended with a '?' if it exists)</span><br><span class="line">%r - First line of the request (method and request URI)</span><br><span class="line">%s - HTTP status code of the response</span><br><span class="line">%S - User session ID</span><br><span class="line">%t - Date and time, in Common Log Format</span><br><span class="line">%u - Remote user that was authenticated (if any), else '-'</span><br><span class="line">%U - Requested URL path</span><br><span class="line">%v - Local server name</span><br><span class="line">%D - Time taken to process the request, in millis</span><br><span class="line">%T - Time taken to process the request, in seconds</span><br><span class="line">%F - Time taken to commit the response, in millis</span><br><span class="line">%I - Current request thread name (can compare later with stacktraces)</span><br><span class="line">%&#123;xxx&#125;i write value of incoming header with name xxx</span><br><span class="line">%&#123;xxx&#125;o write value of outgoing header with name xxx</span><br><span class="line">%&#123;xxx&#125;c write value of cookie with name xxx</span><br><span class="line">%&#123;xxx&#125;r write value of ServletRequest attribute with name xxx</span><br><span class="line">%&#123;xxx&#125;s write value of HttpSession attribute with name xxx</span><br><span class="line">%&#123;xxx&#125;p write local (server) port (xxx==local) or remote (client) port (xxx=remote)</span><br><span class="line">%&#123;xxx&#125;t write timestamp at the end of the request formatted using the enhanced SimpleDateFormat pattern xxx</span><br></pre></td></tr></table></figure></p>
<p>值得一提的是，在观察Access Log后可能产生过滤某些请求的需求，而和AccessLogging相关的功能Access Control可以过滤访问请求。详细可以去<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html#Access_Control" target="_blank" rel="noopener">官网文档</a>查看。</p>
<h4 id="2-2-使用Log4j实现Tomcat日志"><a href="#2-2-使用Log4j实现Tomcat日志" class="headerlink" title="2.2.使用Log4j实现Tomcat日志"></a>2.2.使用Log4j实现Tomcat日志</h4><p>本节介绍如何配置Tomcat以对所有Tomcat的内部日志记录使用log4j而不是java.util.logging。<br>注意：这和我们在项目中使用log4j完全不是一回事，是指用log4j代替JULI实现Tomcat的系统日志。这种替换目的在于使用更加友好的配置方式和更丰富的日志输出方式。<br>以下步骤描述了如何配置log4j以输出Tomcat的内部日志记录。<br>创建log4j.properties配置文件<br>下载log4j v1.2.x<br>在apache tomcat官网下载tomcat-juli.jar 、 tomcat-juli-adapters.jar<br>把log4j.jar 和tomcat-juli-adapters.jar放到tomcat下 的lib文件夹里<br>把bin文件夹下的tomcat-juli.jar用刚刚下载的版本代替<br>删除conf文件夹下的logging.properties文件，防止tomcat生成空日志文件<br>开启tomcat<br>其中log4j.properties的配置和普通log4j一样，只要保证logger的名称是tomcat规定的格式<br>org.apache.catalina.core.ContainerBase.[${engine}].[${host}].[${context}] 格式。例如：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">log4j.rootLogger = INFO, CATALINA</span><br><span class="line"></span><br><span class="line"># Define all the appenders</span><br><span class="line">log4j.appender.CATALINA = org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.CATALINA.File = $&#123;catalina.base&#125;/logs/catalina</span><br><span class="line">log4j.appender.CATALINA.Append = true</span><br><span class="line">log4j.appender.CATALINA.Encoding = UTF-8</span><br><span class="line"># Roll-over the log once per day</span><br><span class="line">log4j.appender.CATALINA.DatePattern = '.'yyyy-MM-dd'.log'</span><br><span class="line">log4j.appender.CATALINA.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.CATALINA.layout.ConversionPattern = %d [%t] %-5p %c- %m%n</span><br><span class="line"></span><br><span class="line">log4j.appender.LOCALHOST = org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.LOCALHOST.File = $&#123;catalina.base&#125;/logs/localhost</span><br><span class="line">log4j.appender.LOCALHOST.Append = true</span><br><span class="line">log4j.appender.LOCALHOST.Encoding = UTF-8</span><br><span class="line">log4j.appender.LOCALHOST.DatePattern = '.'yyyy-MM-dd'.log'</span><br><span class="line">log4j.appender.LOCALHOST.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.LOCALHOST.layout.ConversionPattern = %d [%t] %-5p %c- %m%n</span><br><span class="line"></span><br><span class="line">log4j.appender.MANAGER = org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.MANAGER.File = $&#123;catalina.base&#125;/logs/manager</span><br><span class="line">log4j.appender.MANAGER.Append = true</span><br><span class="line">log4j.appender.MANAGER.Encoding = UTF-8</span><br><span class="line">log4j.appender.MANAGER.DatePattern = '.'yyyy-MM-dd'.log'</span><br><span class="line">log4j.appender.MANAGER.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.MANAGER.layout.ConversionPattern = %d [%t] %-5p %c- %m%n</span><br><span class="line"></span><br><span class="line">log4j.appender.HOST-MANAGER = org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.HOST-MANAGER.File = $&#123;catalina.base&#125;/logs/host-manager</span><br><span class="line">log4j.appender.HOST-MANAGER.Append = true</span><br><span class="line">log4j.appender.HOST-MANAGER.Encoding = UTF-8</span><br><span class="line">log4j.appender.HOST-MANAGER.DatePattern = '.'yyyy-MM-dd'.log'</span><br><span class="line">log4j.appender.HOST-MANAGER.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.HOST-MANAGER.layout.ConversionPattern = %d [%t] %-5p %c- %m%n</span><br><span class="line"></span><br><span class="line">log4j.appender.CONSOLE = org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.CONSOLE.Encoding = UTF-8</span><br><span class="line">log4j.appender.CONSOLE.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.CONSOLE.layout.ConversionPattern = %d [%t] %-5p %c- %m%n</span><br><span class="line"></span><br><span class="line"># Configure which loggers log to which appenders</span><br><span class="line">log4j.logger.org.apache.catalina.core.ContainerBase.[Catalina].[localhost] = INFO, LOCALHOST</span><br><span class="line">log4j.logger.org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager] =\</span><br><span class="line">  INFO, MANAGER</span><br><span class="line">log4j.logger.org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager] =\</span><br><span class="line">  INFO, HOST-MANAGER</span><br></pre></td></tr></table></figure></p>
<h2 id="Tomcat-log4j日志方案示例"><a href="#Tomcat-log4j日志方案示例" class="headerlink" title="Tomcat+log4j日志方案示例"></a>Tomcat+log4j日志方案示例</h2><h3 id="开发环境推荐配置"><a href="#开发环境推荐配置" class="headerlink" title="开发环境推荐配置"></a>开发环境推荐配置</h3><p>以下配置的目的：在控制台只输出所有代码中抛出的debug级别及以上的日志信息，并在文件中保留当次启动的输出日志便于复查。<br>达成上面目标的主要困难是：<br>1.使用相对路径时，日志文件很难找<br>这里的处理方法是在windows中干脆用绝对路径<br>也可以使用log4j2的特性lookup，${log4j:configParentLocation}定位到配置文件的上级目录，${sys:catalina.home}定位到tomcat目录</p>
<p>2.spring、hibernate、dubbo……这些框架使用commons-logging自动往我们的日志里塞内容导致日志过于庞大<br>这里的处理方法是根据实际使用框架的情况，定义对应的logger将它指定为OFF级别。<br>或者在要使用的日志中指定name为自己的包名如”com.tplink”，就只输出这个包的日志。<br>也可以提升整体日志级别到error，因为一般这些框架输出的级别都在debug和info。<br>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- log4j-slf4j-impl(用于log4j2与slf4j集成) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!--先定义默认的日志级别--&gt;</span><br><span class="line">&lt;configuration status=&quot;debug&quot;&gt;</span><br><span class="line">    &lt;!--先定义所有的appender--&gt;</span><br><span class="line">    &lt;ThresholdFilter level=&quot;debug&quot; onMatch=&quot;ACCEPT&quot; onMismatch=&quot;DENY&quot;/&gt;</span><br><span class="line">    &lt;appenders&gt;</span><br><span class="line">       &lt;!--这个输出控制台的配置 节点名字是Appender name属性下面配置logger要用到--&gt;</span><br><span class="line">        &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot; additivity=&quot;true&quot;&gt;</span><br><span class="line">            &lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span><br><span class="line">            &lt;PatternLayout pattern=&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n&quot;/&gt;</span><br><span class="line">        &lt;/Console&gt;</span><br><span class="line">        &lt;!--文件会打印出所有信息，这个log每次运行程序会自动清空，由append属性决定，这个也挺有用的，适合临时测试用--&gt;</span><br><span class="line">        &lt;File name=&quot;test&quot; fileName=&quot;d:/logs/test.log&quot; append=&quot;false&quot; additivity=&quot;true&quot;&gt;</span><br><span class="line">            &lt;PatternLayout pattern=&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n&quot;/&gt;</span><br><span class="line">        &lt;/File&gt;</span><br><span class="line">&lt;!—也可以使用项目目录存放日志文件 --&gt;</span><br><span class="line">        &lt;!--&lt;File name=&quot;test&quot; fileName=&quot;$&#123;log4j:configParentLocation&#125;/logs/test.log&quot; append=&quot;false&quot; additivity=&quot;true&quot;&gt;--&gt;</span><br><span class="line">&lt;!--&lt;PatternLayout pattern=&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n&quot;/&gt;--&gt;</span><br><span class="line">&lt;!--&lt;/File&gt;</span><br><span class="line">    &lt;/appenders&gt;</span><br><span class="line">    &lt;!--然后定义logger--&gt;</span><br><span class="line">    &lt;loggers&gt;</span><br><span class="line">        &lt;!--过滤掉spring和hibernate的一些无用的debug信息--&gt;</span><br><span class="line">        &lt;logger name=&quot;org.springframework&quot; level=&quot;off&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">        &lt;/logger&gt;</span><br><span class="line">        &lt;logger name=&quot;org.hibernate&quot; level=&quot;off&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">        &lt;/logger&gt;</span><br><span class="line">        &lt;!--建立一个默认的root的logger--&gt;</span><br><span class="line">        &lt;root level=&quot;all&quot;&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;test&quot;/&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;Console&quot;/&gt;</span><br><span class="line">        &lt;/root&gt;</span><br><span class="line">    &lt;/loggers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h3 id="查找特定bug时的推荐配置"><a href="#查找特定bug时的推荐配置" class="headerlink" title="查找特定bug时的推荐配置"></a>查找特定bug时的推荐配置</h3><p>和开发情况下的配置类似，只是loggers需要限定到疑似出现问题的特定包、类就可以<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="comment">&lt;!--先定义默认的日志级别--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"debug"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--先定义所有的appender--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"debug"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--这个输出控制台的配置 节点名字是Appender name属性下面配置logger要用到--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span> <span class="attr">additivity</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件会打印出所有信息，这个log每次运行程序会自动清空，由append属性决定，这个也挺有用的，适合临时测试用--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">fileName</span>=<span class="string">"d:/logs/test.log"</span> <span class="attr">append</span>=<span class="string">"false"</span> <span class="attr">additivity</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">!—也可以使用项目目录存放日志文件</span> <span class="attr">--</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;File name="test" fileName="$&#123;log4j:configParentLocation&#125;/logs/test.log" append="false" additivity="true"&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;PatternLayout pattern="%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"/&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;/File&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appenders</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--然后定义logger--&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.tplink.ebs"</span> <span class="attr">level</span>=<span class="string">"off"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="测试、正式环境推荐配置"><a href="#测试、正式环境推荐配置" class="headerlink" title="测试、正式环境推荐配置"></a>测试、正式环境推荐配置</h3><p>和现在项目相比，这种配置的目的是削减catalina.out的输出，作为替换用log4j的文件记录每天的日志。<br>log4j2.xml<br>配置的目的是设置两个文件MITP.log和MIFULL.log分别输出自己代码的异常和全部异常,在文件大小达到SizeBasedTriggeringPolicy设置的值后，会按日期分文件夹并存为压缩文件。文件存放地点是tomcat目录下的logs文件夹<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="comment">&lt;!--先定义默认的日志级别--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"error"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--先定义所有的appender--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appenders</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--这个输出控制台的配置 节点名字是Appender name属性下面配置logger要用到--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--这个会打印出所有的信息，每次大小超过size，则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"RollingFileFull"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/MIFull.log"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/$$&#123;date:yyyy-MM&#125;/MIFULL-%d&#123;MM-dd-yyyy&#125;-%i.log.gz"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;yyyy-MM-dd 'at' HH:mm:ss z&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"50MB"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"RollingFileTP"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/MITP.log"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/$$&#123;date:yyyy-MM&#125;/MITP-%d&#123;MM-dd-yyyy&#125;-%i.log.gz"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;yyyy-MM-dd 'at' HH:mm:ss z&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"50MB"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appenders</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--然后定义logger--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loggers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--建立一个默认的root的logger--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">additivity</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"RollingFileFull"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.tplink"</span> <span class="attr">level</span>=<span class="string">"error"</span>  <span class="attr">additivity</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"RollingFileTP"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>tomcat logging.properties<br>和默认配置文件比只改了Catalina的输出级别为OFF<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="line"># contributor license agreements.  See the NOTICE file distributed with</span><br><span class="line"># this work for additional information regarding copyright ownership.</span><br><span class="line"># The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="line"># (the "License"); you may not use this file except in compliance with</span><br><span class="line"># the License.  You may obtain a copy of the License at</span><br><span class="line">#</span><br><span class="line">#     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># Unless required by applicable law or agreed to in writing, software</span><br><span class="line"># distributed under the License is distributed on an "AS IS" BASIS,</span><br><span class="line"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"># See the License for the specific language governing permissions and</span><br><span class="line"># limitations under the License.</span><br><span class="line"></span><br><span class="line">handlers = 1catalina.org.apache.juli.FileHandler, 2localhost.org.apache.juli.FileHandler, 3manager.org.apache.juli.FileHandler, 4host-manager.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler</span><br><span class="line"></span><br><span class="line">.handlers = 1catalina.org.apache.juli.FileHandler, java.util.logging.ConsoleHandler</span><br><span class="line"></span><br><span class="line">############################################################</span><br><span class="line"># Handler specific properties.</span><br><span class="line"># Describes specific configuration info for Handlers.</span><br><span class="line">############################################################</span><br><span class="line"></span><br><span class="line">1catalina.org.apache.juli.FileHandler.level = FINE</span><br><span class="line">1catalina.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">1catalina.org.apache.juli.FileHandler.prefix = catalina.</span><br><span class="line"></span><br><span class="line">2localhost.org.apache.juli.FileHandler.level = FINE</span><br><span class="line">2localhost.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">2localhost.org.apache.juli.FileHandler.prefix = localhost.</span><br><span class="line"></span><br><span class="line">3manager.org.apache.juli.FileHandler.level = FINE</span><br><span class="line">3manager.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">3manager.org.apache.juli.FileHandler.prefix = manager.</span><br><span class="line"></span><br><span class="line">4host-manager.org.apache.juli.FileHandler.level = FINE</span><br><span class="line">4host-manager.org.apache.juli.FileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">4host-manager.org.apache.juli.FileHandler.prefix = host-manager.</span><br><span class="line"></span><br><span class="line">java.util.logging.ConsoleHandler.level = OFF</span><br><span class="line">java.util.logging.ConsoleHandler.formatter = java.util.logging.SimpleFormatter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">############################################################</span><br><span class="line"># Facility specific properties.</span><br><span class="line"># Provides extra control for each logger.</span><br><span class="line">############################################################</span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = ERROR</span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.org.apache.juli.FileHandler</span><br><span class="line"></span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level = ERROR</span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].handlers = 3manager.org.apache.juli.FileHandler</span><br><span class="line"></span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].level = ERROR</span><br><span class="line">org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].handlers = 4host-manager.org.apache.juli.FileHandler</span><br><span class="line"></span><br><span class="line"># For example, set the org.apache.catalina.util.LifecycleBase logger to log</span><br><span class="line"># each component that extends LifecycleBase changing state:</span><br><span class="line">#org.apache.catalina.util.LifecycleBase.level = FINE</span><br><span class="line"></span><br><span class="line"># To see debug messages in TldLocationsCache, uncomment the following line:</span><br><span class="line">#org.apache.jasper.compiler.TldLocationsCache.level = FINE</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/26/django/" rel="next" title="使用django从数据库反转成cms系统流程">
                <i class="fa fa-chevron-left"></i> 使用django从数据库反转成cms系统流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">M Yi</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#log4j（1-2-x）"><span class="nav-number">1.</span> <span class="nav-text">log4j（1.2.x）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#log4j实现源码"><span class="nav-number">1.1.</span> <span class="nav-text">log4j实现源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log4j使用配置"><span class="nav-number">1.2.</span> <span class="nav-text">log4j使用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置根Logger："><span class="nav-number">1.2.1.</span> <span class="nav-text">配置根Logger：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置日志信息输出目的地（appender）："><span class="nav-number">1.2.2.</span> <span class="nav-text">配置日志信息输出目的地（appender）：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置日志信息的输出格式（Layout）："><span class="nav-number">1.2.3.</span> <span class="nav-text">配置日志信息的输出格式（Layout）：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#屏蔽框架输出日志干扰"><span class="nav-number">1.2.4.</span> <span class="nav-text">屏蔽框架输出日志干扰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件总览"><span class="nav-number">1.2.5.</span> <span class="nav-text">配置文件总览</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#同项目内多个logger配置"><span class="nav-number">1.2.6.</span> <span class="nav-text">同项目内多个logger配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义Appender"><span class="nav-number">1.3.</span> <span class="nav-text">自定义Appender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志性能优化"><span class="nav-number">1.4.</span> <span class="nav-text">日志性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用xml配置"><span class="nav-number">1.5.</span> <span class="nav-text">使用xml配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#log4j2"><span class="nav-number">2.</span> <span class="nav-text">log4j2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-log4j2优点"><span class="nav-number">2.1.</span> <span class="nav-text">2.1.log4j2优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log4j2的使用配置"><span class="nav-number">2.2.</span> <span class="nav-text">log4j2的使用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#导入包"><span class="nav-number">2.2.1.</span> <span class="nav-text">导入包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件"><span class="nav-number">2.2.2.</span> <span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#log4j迁移到log4j2"><span class="nav-number">2.2.3.</span> <span class="nav-text">log4j迁移到log4j2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#屏蔽框架输出日志干扰-1"><span class="nav-number">2.2.4.</span> <span class="nav-text">屏蔽框架输出日志干扰</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomcat日志"><span class="nav-number">3.</span> <span class="nav-text">Tomcat日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat日志种类介绍"><span class="nav-number">3.1.</span> <span class="nav-text">Tomcat日志种类介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat日志配置"><span class="nav-number">3.2.</span> <span class="nav-text">Tomcat日志配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#默认JULI实现下的配置"><span class="nav-number">3.2.1.</span> <span class="nav-text">默认JULI实现下的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#logging-properties的三段结构"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">logging.properties的三段结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Access-Logging的特殊性"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">Access Logging的特殊性</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-使用Log4j实现Tomcat日志"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2.使用Log4j实现Tomcat日志</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomcat-log4j日志方案示例"><span class="nav-number">4.</span> <span class="nav-text">Tomcat+log4j日志方案示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#开发环境推荐配置"><span class="nav-number">4.1.</span> <span class="nav-text">开发环境推荐配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查找特定bug时的推荐配置"><span class="nav-number">4.2.</span> <span class="nav-text">查找特定bug时的推荐配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试、正式环境推荐配置"><span class="nav-number">4.3.</span> <span class="nav-text">测试、正式环境推荐配置</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">M Yi</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
